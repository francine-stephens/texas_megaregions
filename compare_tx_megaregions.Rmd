---
title: "SAA vs. DFW Metro Native Population Growth Comparison"
author: "Francine Stephens"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE, echo = FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(tigris)
library(tmap)
library(sf)
library(extrafont)
loadfonts(device = "win")
options(tigris_use_cache = TRUE)

# Parameters
data_folder <- "data/"
outputs_folder <- "outputs/"
source("geographic_parameters.R")
tx_ea_lambert <- 3082


# Data
county_seats_sf <- readRDS(paste0(
  data_folder, 
  "county_seats_sf.rds"))
pop_estimates <- readRDS(paste0(
  data_folder, 
  "population_estimates_2022.rds"))
pop_estimates17 <- readRDS(paste0(
  data_folder, 
  "population_estimates_2017.rds"))


```


# Clean Data
```{r}
# 2022 Pop Stats
pop_estimates_aoi <- pop_estimates %>% 
  mutate(state = substr(GEOID, 1, 2),
         county_name =  str_remove_all(NAME , " County, Texas")) %>% 
  filter(state == "48" & county_name %in% county_table$all_counties) %>% 
  pivot_wider(names_from = "variable",
              values_from = "value") %>% 
  mutate(birth_death_ratio = BIRTHS/DEATHS,
         domestic_int_ratio = DOMESTICMIG/INTERNATIONALMIG) %>% 
  left_join(., county_table, by = c("county_name" = "all_counties"))


# Pop Change
pop_change_cities <- pop_estimates_aoi %>% 
  select(GEOID, NAME, county_name, megaregion, POPESTIMATE) %>% 
  rename(POP2022 = "POPESTIMATE") %>% 
  left_join(., pop_estimates17 %>% 
              st_set_geometry(NULL) %>% 
              select(GEOID, POP2017 = "value"), by = "GEOID") %>% 
  mutate(pop_chg = ((POP2022 - POP2017)/(POP2017)) * 100)

metro_growth_rt <- pop_change_cities %>% 
  st_set_geometry(NULL) %>% 
  group_by(megaregion) %>% 
  summarize(across(where(is.numeric), ~sum(.x, na.rm = TRUE))) %>% 
  ungroup() %>% 
  mutate(pop_chg = ((POP2022 - POP2017)/(POP2017)) * 100)

```

```{r}
pop_change_cities %>% 
  st_set_geometry(NULL) %>%
  arrange(desc(pop_chg))

```


# Tabulate pop metrics to mega-region
```{r}
metro_pop_counts <- pop_estimates_aoi %>% 
  group_by(megaregion) %>% 
  summarize(population = sum(POPESTIMATE, na.rm = TRUE),
            natural_change = sum(NATURALCHG, na.rm = TRUE),
            births = sum(BIRTHS, na.rm = TRUE),
            deaths = sum(DEATHS, na.rm = TRUE),
            netmig = sum(NETMIG, na.rm = TRUE),
            international = sum(INTERNATIONALMIG, na.rm = TRUE),
            domestic = sum(DOMESTICMIG, na.rm = TRUE)
            ) %>% 
  ungroup() %>% 
  mutate(birth_death_ratio = births/deaths,
         natural_change_rate = natural_change/population * 1000,
         netmig_rate = netmig/population * 1000,
         birth_rate = births/population * 1000,
         deaths_rate = deaths/population * 1000
         ) %>% 
  left_join(., metro_growth_rt, by = "megaregion")

metro_pop_counts %>% 
  select(megaregion, pop_chg)
```

```{r}
st_crs(pop_estimates_aoi)

metro_area <- pop_estimates_aoi %>% 
  st_transform(., crs = tx_ea_lambert) %>% 
  mutate(area = st_area(.),
         area_mi = as.numeric(area) * 0.00000038610215855
         ) %>% 
  group_by(megaregion) %>% 
  summarize(Area = sum(area_mi, na.rm = TRUE)
            ) %>% 
    ungroup()
  
  
metro_area 
```

